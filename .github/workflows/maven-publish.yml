# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  release:
    types: [created]

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
        settings-path: ${{ github.workspace }} # location for the settings.xml file
        cache: 'maven'

    - name: Create stub dependencies (API only)
      run: |
        # Prepare directories
        mkdir -p lib stub-classes \
          stub-src/com/Zrips/CMI/Modules/Warp \
          stub-src/de/bluecolored/bluemap/api/markers \
          stub-src/de/bluecolored/bluemap/api

        # CMI stubs (only signatures used by this plugin)
        cat > stub-src/com/Zrips/CMI/CMI.java << 'EOF'
        package com.Zrips.CMI;
        public class CMI extends org.bukkit.plugin.java.JavaPlugin {
            public ModuleManager getModuleManager() { return new ModuleManager(); }
            public static class ModuleManager {
                public com.Zrips.CMI.Modules.ModuleBase getModule(String name) { return null; }
            }
        }
        EOF

        cat > stub-src/com/Zrips/CMI/Modules/ModuleBase.java << 'EOF'
        package com.Zrips.CMI.Modules;
        public class ModuleBase {}
        EOF

        cat > stub-src/com/Zrips/CMI/Modules/Warp/Warp.java << 'EOF'
        package com.Zrips.CMI.Modules.Warp;
        import org.bukkit.Location;
        import java.util.*;
        public class Warp extends com.Zrips.CMI.Modules.ModuleBase {
            public java.util.List<Warp> getAllWarps() { return java.util.Collections.emptyList(); }
            public Location getLocation() { return null; }
            public String getName() { return ""; }
        }
        EOF

        # BlueMap API stubs (only signatures used by this plugin)
        cat > stub-src/de/bluecolored/bluemap/api/BlueMapAPI.java << 'EOF'
        package de.bluecolored.bluemap.api;
        import java.util.*;
        import java.util.function.Consumer;
        public class BlueMapAPI {
            public static boolean isLoaded() { return true; }
            public static Optional<BlueMapAPI> getInstance() { return Optional.of(new BlueMapAPI()); }
            public static void onEnable(Consumer<BlueMapAPI> consumer) { consumer.accept(new BlueMapAPI()); }
            public Collection<de.bluecolored.bluemap.api.BlueMapMap> getMaps() { return java.util.Collections.emptyList(); }
        }
        EOF

        cat > stub-src/de/bluecolored/bluemap/api/BlueMapMap.java << 'EOF'
        package de.bluecolored.bluemap.api;
        import java.util.*;
        import de.bluecolored.bluemap.api.markers.MarkerSet;
        public class BlueMapMap {
            public Collection<MarkerSet> getMarkerSets() { return new ArrayList<>(); }
            public MarkerSet createMarkerSet(String id) { return new MarkerSet(); }
            public String getName() { return "map"; }
        }
        EOF

        cat > stub-src/de/bluecolored/bluemap/api/markers/MarkerSet.java << 'EOF'
        package de.bluecolored.bluemap.api.markers;
        import java.util.*;
        public class MarkerSet {
            private String label;
            private Map<String, POIMarker> markers = new HashMap<>();
            public String getLabel() { return label; }
            public void setLabel(String label) { this.label = label; }
            public Map<String, POIMarker> getMarkers() { return markers; }
            public void put(String id, POIMarker marker) { markers.put(id, marker); }
            public void remove(String id) { markers.remove(id); }
        }
        EOF

        cat > stub-src/de/bluecolored/bluemap/api/markers/POIMarker.java << 'EOF'
        package de.bluecolored.bluemap.api.markers;
        public class POIMarker {
            public static Builder builder() { return new Builder(); }
            public static class Builder {
                public Builder label(String l) { return this; }
                public Builder description(String d) { return this; }
                public Builder position(double x, double y, double z) { return this; }
                public POIMarker build() { return new POIMarker(); }
            }
        }
        EOF

        # Download Paper API for Bukkit types
        mvn dependency:get -Dartifact=io.papermc.paper:paper-api:1.20.4-R0.1-SNAPSHOT

        # Compile stubs
        javac -d stub-classes \
          -cp ~/.m2/repository/io/papermc/paper/paper-api/1.20.4-R0.1-SNAPSHOT/paper-api-1.20.4-R0.1-SNAPSHOT.jar \
          $(find stub-src -name "*.java") || true

        # Package into JARs
        cd stub-classes && jar cf ../lib/CMI-9.8.5.0.jar com && jar cf ../lib/BlueMapAPI-2.3.0.jar de && cd ..

        # Install stubs to local Maven repo (compile-only; real plugins provided at runtime)
        mvn install:install-file -Dfile=lib/CMI-9.8.5.0.jar -DgroupId=com.Zrips -DartifactId=CMI -Dversion=9.8.5.0 -Dpackaging=jar
        mvn install:install-file -Dfile=lib/BlueMapAPI-2.3.0.jar -DgroupId=de.bluecolored.bluemap -DartifactId=BlueMapAPI -Dversion=2.3.0 -Dpackaging=jar

    - name: Build with Maven
      run: mvn -B package --file pom.xml -DskipTests -Dmaven.test.skip=true

    - name: Publish to GitHub Packages Apache Maven
      run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml
      env:
        GITHUB_TOKEN: ${{ github.token }}
